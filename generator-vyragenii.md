<!-- TITLE: Генератор выражений -->
<!-- SUBTITLE: Руководство пользователясистемы «ВИТАКОР» -->

# 	Общие сведения о системе
## 	Структура данных

Состав сущностей, их атрибуты и связи между сущностями составляют информационную модель системы, которую определяет разработчик системы на этапе ее проектирования.

Сущность – это логическая модель какого-либо реально существующего объекта – например, организации, физического лица, документа и т.д., факт существования и определенные характеристики которого необходимо учесть в системе.

Атрибут сущности – характеристика, параметр, описывающий определенное свойство сущности. Например, атрибут «Имя» описывает соответствующее свойство сущности «Человек». Описание сущности в системе включает ее наименование, описание всех ее возможных атрибутов, ключи и другие служебные данные.

Каждая сущность имеет ключ – один или несколько атрибутов, однозначно идентифицирующих экземпляр сущности.

Экземпляр сущности - набор конкретных значений атрибутов сущности, которой принадлежит этот экземпляр. Каждый экземпляр сущности имеет уникальный идентификатор (значение ключа). Экземпляры сущности образуют список, структура которого определяется описанием сущности в системе.

Связь между сущностями реализуется с помощью атрибутов-ссылок. Атрибут-ссылка содержит идентификатор элемента (экземпляра) другой сущности. Например, сущность «Страховой полис» должна иметь атрибут-ссылку «Пациент», в котором будет храниться идентификатор пациента, которому принадлежит данный полис.

Таким образом, практически для каждой сущности в базе данных системы существуют:
* 	сущности, на которые она ссылается, или parent-сущности,
* 	сущности, которые ссылаются на нее, или child-сущности.
 	
Существует еще один вид связей между сущностями – наследование. Наследование означает, что может существовать сущность (сущность-наследник), производная от некоторой базовой сущности (сущность-предок). Производная сущность наследует от базовой ее атрибуты и может дополнительно иметь свои собственные.

Например, существует базовая сущность «Медицинская запись», имеющая атрибуты:
* 	«Идентификатор»,
* 	«Дата записи»,
* 	«Пользователь».
 	
И существует производная сущность «Амбулаторная медицинская запись», которая будет иметь следующие атрибуты:
* 	«Идентификатор» (унаследован от «Медицинская запись»),
* 	«Дата записи» (унаследован от «Медицинская запись»),
* 	«Пользователь» (унаследован от «Медицинская запись»),
* 	«Амбулаторная карта» (собственный атрибут).

## 	Типы данных
Любое значение в системе (значение атрибута, константное значение, переменная и т.д.) имеет определенный тип. Возможные типы данных приведены в Табл.

Атрибут любого типа может иметь значение NULL (т.е. пустое значение). Следует иметь в виду, что для текстовых данных пустая строка «» не является пустым значением, также как и число 0 для числовых данных.

|   ||
|:------------- |:---------------|
|Текст (Text)|Значение, представленное текстовой строкой.|
|Число(целое – Ordinal, дробное – Float)|Числовое значение: целое или дробное (с плавающей точкой) число.|
|Логический (Logical)|Значение, которое может иметь одно из двух состояний: да/нет, или истина/ложь.|
|Дата (DateTime)|Значение, содержащее информацию о дате и времени, т.е. идентифицирующее момент времени.|
|Идентификатор (Guid)|Значение, имеющее тип универсального идентификатора GUID.|
|Объект (Object)|Cложный тип данных (в отличие от перечисленных выше), который может содержать набор элементов различных типов, как простых, так и сложных.|

## 	Вычисляемые атрибуты
Помимо атрибутов, значения которых хранятся в базе данных, существуют атрибуты, значение которых вычисляется в момент отображения списка данных, включения данных в отчет и т.д. Правила вычисления таких атрибутов задаются разработчиком при описании сущности.

Вычисляемые атрибуты могут быть двух типов – простые и параметрические. Значение простого вычисляемого атрибута не зависит от текущего контекста и может быть вычислено без указания каких-либо дополнительных условий (параметров).

Для вычисления параметрического атрибута необходимо запросить значение параметра (или нескольких параметров) у пользователя. Стандартное окно запроса параметров описано в базовом руководстве пользователя, п. 5.2.4.

## 	Пользовательские атрибуты
Кроме атрибутов, созданных на этапе разработки системы, сущности могут содержать дополнительные (пользовательские) атрибуты. Пользовательские атрибуты могут быть добавлены пользователем (администратором) в процессе эксплуатации системы.

Создание пользовательских атрибутов описано в руководстве администратора по настройке системы.
 
# 	Генератор выражений
Выражение представляет собой набор инструкций по произведению определенных действий (операций) над объектами (операндами). Операции различаются по типу операндов и типу результата выполнения операции – логические, арифметические, строковые (текстовые) и т.д. Выражения в системе используются для наложения различных условий на данные при поиске (фильтрации) данных, отборе данных для отчетов, проверке правильности ввода данных и т.д. Для создания и редактирования предназначен специальный программный модуль - генератор выражений. Генератор предоставляет два режима работы:
* 	режим графического конструктора, с которым могут работать пользователи, не знакомые с языками программирования ([подраздел 2.2](#g1));
* 	режим текстового редактора для создания выражений на языке XML ([подраздел 2.7](#g2)).
 	
[Подраздел 2.1](#g3) описывает структуру и правила создания выражений. При этом используется терминология и обозначения, принятые в графическом конструкторе.

## 	Структура выражения
Возможные операции над объектами можно условно разделить на две группы: операции и функции. Деление условное, т.к. функция – тоже операция над данными, но операции и функции, как правило, имеют различное написание (синтаксис):
* 	операция: ОПЕРАНД1 ОПЕРАТОР ОПЕРАНД2,
* 	функция: ФУНКЦИЯ (АРГУМЕНТ1, АРГУМЕНТ2, …).
 	
Здесь ОПЕРАТОР – это условное обозначение операции, ФУНКЦИЯ – заголовок (имя) функции.

Выражения могут быть вложенными, т.е. в качестве операнда или аргумента может выступать как функция, так и выражение.

В качестве операндов выражений могут выступать объекты, перечисленные в Табл. 2.1. Операнды могут содержать значения (данные) различных типов (типы данных описаны в [п. 1.2 Руководства](#g4)).

Все возможные виды операторов и описание соответствующих им операций приведены в Табл. 2.2, перечень функций – в Табл. 2.3


| Операнд  |Элемент интерфейса конструктора|Описание|
|:------------- |:---------------|:---------------|
|Атрибут сущности|Панель атрибутов	|Общая информация о сущностях и их атрибутах приведена в п. 1 настоящего руководства.<br>Использование атрибутов сущностей в выражениях описано в [п.2.3.1.](#g5)|
|Константное значение (константа)	|Панель инструментов  ![1](/uploads/000003/1.png "1")	|Величина, значение которой не меняется в процессе выполнения программы и фиксируется при создании условия.<br>Применение константных значений описано в [п.2.3.2.](#g6)|
|Системный параметр	|Панель инструментов  ![2](/uploads/000003/2.png "2")	|Параметр, значение которого определяется в момент вычисления результата выражения. Перечень системных параметров ограничен и создается на этапе разработки системы.<br>Применение системных параметров описано в [п.2.3.3.](#g7)|
|Пользовательский параметр	|Панель инструментов  ![3](/uploads/000003/3.png "3")	|Пользовательский параметр, значение которого запрашивается приложением у пользователя в момент вычисления результата выражения.<br>Применение пользовательских параметров описано в [п.2.3.4.](#g8)|

| Элемент интерфейса |Оператор|Тип операнда|Тип результата|Описание|
|:------------- |:---------------|:---------------|:---------------|:---------------|
|![4](/uploads/000003/4.png "4")|Логическое ИЛИ|	Лог.	|Лог.	|Объединение операндов – логических значений или выражений (условий) через «или», т.е. положительным результатом выражения будет выполнение любого из этих условий.|
|![5](/uploads/000003/5.png "5")|Логическое И	|Лог.	|Лог.	|Объединение условий через «и», т.е. положительным результатом выражения будет одновременное выполнение всех этих условий.|
|![6](/uploads/000003/6.png "6")|Похоже	|Строка	|Лог.	|Возвращает положительный результат, если значение удовлетворяет определенному шаблону. Подробное описание оператора и применение шаблонов приведено в п. [п.2.4.1.](#g9) Руководства.|
|![7](/uploads/000003/7.png "7")|Равно	|Число, строка	|Лог.	|Точное равенство операндов – чисел, строк, дат и т.д. Регистр символов строки данной операцией игнорируется, т.е. строки «Текст» и «текст» равны.|
|![8](/uploads/000003/8.png "8")|Не равно	|Число, строка	|Лог.	|Операнды не должны быть равны друг другу. В случае строк это означает, что строки не должны совпадать.|
|![9](/uploads/000003/9.png "9")|Меньше или равно	|Число	|Лог.	|Значение первого (левого) операнда должно быть меньше или равно значению второго (правого).|
|![10](/uploads/000003/10.png "10")|Больше или равно	|Число	|Лог.	|Значение первого (левого) операнда должно быть больше или равно значению второго (правого).|
|![11](/uploads/000003/11.png "11")|Меньше	|Число	|Лог.	|Значение первого (левого) операнда должно быть меньше значения второго (правого)|.
|![12](/uploads/000003/12.png "12")|Больше	|Число	|Лог.	|Значение первого (левого) операнда должно быть больше значения второго (правого).|
||IN (Входит в…)	|Любой	|Лог.	|Значение первого операнда должно быть равно значению одного из элементов перечисления (списка значений) второго операнда, [см. п.2.4.2.](#g10)|
||NOT (Не)	|Лог.	|Лог.	|Оператор отрицания, применяется только в связке с другими операторами. [см. п.2.4.3.](#g11)|
||IS	|Объект	|Лог.	|Оператор накладывает условие на сущность, на которую указывает атрибут-ссылка.Подробно [см. п.2.4.4.](#g12)|
||ExactIS	|Объект	|Лог.	|Оператор накладывает условие на сущность, на которую указывает атрибут-ссылка.Подробно [см. п.2.4.5.](#g13)|
|![13](/uploads/000003/13.png "13")|Сложение	|Число, Строка	|Число, Строка	|Арифметический оператор сложения, либо оператор сложения (конкатенации) строк.|
|![14](/uploads/000003/14.png "14")|Вычитание	|Число	|Число	|Арифметический оператор вычитания.|
|![15](/uploads/000003/15.png "15")|Умножение	|Число	|Число	|Арифметический оператор умножения.|
|![16](/uploads/000003/16.png "16")|Деление	|Число	|Число	|Арифметический оператор деления.|
|![17](/uploads/000003/17.png "17")|Скобки	|-	|-	|Скобки определяют очередность вычислений ([см. п.2.3.7.](#g14)).|
|![18](/uploads/000003/18.png "18")|Разность дат	|Дата	|Целое число	|Функция, позволяющая вычислить разность между двумя датами в различных единицах измерения – годах, месяцах, днях и т.д.Применение функции описано в [п.2.5.1.](#g15)|
|![19](/uploads/000003/19.png "19")|Прибавить к дате	|Дата	|Дата	|Функция, позволяющая вычислить дату путем добавления периода к исходной дате. Период может быть выражен в годах, месяцах, днях и т.д. Применение функции описано в  [п.2.5.2.](#g16)|
|![20](/uploads/000003/20.png "20")|Получить часть даты|	Дата	|Целое число	|Функция получения части даты в виде числа (год, месяц, номер недели в году и т.д.).Применение функции описано в  [п.2.5.3.](#g17)|
|![21](/uploads/000003/21.png "21")|Подстрока	|Текст	|Текст	|Функция получения заданной части текстовой строки (подстроки).Применение функции описано в  [п.2.5.4.](#g18)|
|![22](/uploads/000003/22.png "22")|Длина строки	|Текст	|Целое число	|Функция вычисления длины строки в символах.Применение функции описано в  [п.2.5.5.](#g19)|
|![23](/uploads/000003/23.png "23")|Значение функции	|Число	|Число	|Вычисление математической функции. Руководство содержит описание наиболее употребительных функций:<br>•	Получение абсолютного значения ( [п.2.5.6.](#g20))|
|![24](/uploads/000003/24.png "24")|Привести к типу	|Любой	|Любой 	|Функция позволяет преобразовать значение аргумента функции к требуемому типу данных.Применение функции описано в  [п.2.5.7.](#g21)|
|![25](/uploads/000003/25.png "25")|Удовлет-воряет выражению	|Текст	|Целое число	Функция позволяет анализировать значение аргумента с помощью регулярных выражений.Применение функции описано в  [п.2.5.8.](#g22)|
|![26](/uploads/000003/26.png "26")|Условие	|Логический	|Любой	|Позволяет вставить в выражение условную конструкцию вида «Если … тогда … иначе …».Применение функции описано в  [п.2.5.9.](#g23)|
|![27](/uploads/000003/27.png "27")|Количество элементов в коллекции	|Объект	|Целое число	|Функция подсчета количества элементов в указанной коллекции элементов типа «Объект».Применение функции описано в  [п.2.6.1.](#g24)|
|![28](/uploads/000003/28.png "28")|Выбрать	|Сущ-ность	|Коллекция	|Функция позволяет сделать выборку значений определенного атрибута заданной сущности.Применение функции описано в [п.2.6.2.](#g25)|
|![29](/uploads/000003/29.png "29")|Существует	|Сущ-ность	|Логический	|Функция позволяет проверить факт существования данных сущности, удовлетворяющих определенным условиям.Применение функции описано в [п.2.6.3.](#g26)|
|![30](/uploads/000003/30.png "30")|Поиск по дереву	|Сущ-ность	|Логический	|Функция анализа дерева наследования.Применение функции описано в [п.2.6.4.](#g27)|

## 	Графический конструктор
### 	Интерфейс конструктора

Форма генератора условий в режиме конструктора показана на Рис.

![31](/uploads/000003/31.jpg "31")

Форма состоит из четырех разделов:
* 	Управляющая панель (в верхней части формы).
* 	Панель атрибутов сущности (левая часть формы).
* 	Панель инструментов (часть формы между панелью атрибутов и панелью выражения).
* 	Панель выражения или редактирования выражения (правая часть формы).

Между панелями атрибутов, инструментов и выражения расположены сплиттеры, которые позволяют настраивать размеры областей друг относительно друга.

Содержимое управляющей панели описано в Табл. 2.4. Функции конструктора, не представленные на панели инструментов, описаны в

| |||
|:------------- |:---------------|:---------------|
|![32](/uploads/000003/32.jpg "32")|Режим конструктора	|Включение режима конструктора выражений. Включение кнопки автоматически отключает кнопку режима XML-редактора.|
|![33](/uploads/000003/33.jpg "33")|Режим XML-редактора	|Переход в режим XML-редактора. Включение кнопки автоматически отключает кнопку режима конструктора.С помощью этого режима также можно просмотреть XML-код выражения, созданного с помощью конструктора .|
|![34](/uploads/000003/34.png "34")|Отменить действие	|Отменить последнее изменение в выражении. Также для вызова данной функции можно применить сочетание клавиш [Ctrl+Z].|
|![35](/uploads/000003/35.png "35")|Вернуть действие	|Вернуть последнее отмененное изменение.|
|![36](/uploads/003/36.png "36")|Отображать ошибки	|Включает/отключает режим отображения ошибок (по умолчанию включен), когда ошибочные конструкции выделяются красной рамкой. Ситуация, когда режим проверки может быть отключен, описана в [п.2.8](#g28)|
|![37](/uploads/003/37.png "37")|Упорядочить параметры	|Функция предназначена для управления порядком элементов в списке пользовательских параметров ([п.2.7.](#g2)).|

| Пункт контекстного меню|Клавиша(комбинация клавиш)|Описание|
|:------------- |:---------------|:---------------|
|-	|Одинарный клик мышью	|Выделение элемента выражения, на область которого наведен указатель мыши. Клик на заголовке логического оператора вызывает выделение всей конструкции, связанной с этим оператором.|
|-	|Двойной клик мышью	|Редактирование элемента выражения, на область которого наведен указатель мыши.|
|Удалить	|[Delete]	|Удаление выделенного элемента выражения.|
|Копировать	|[Ctrl+C]	|Копирование в буфер обмена содержимого выделенного элемента выражения.|
|Вставить	|[Ctrl+V]	|Вставка на место выделенного элемента выражения содержимого буфера обмена.|

В нижней части панели атрибутов располагается ярлык с отображением наименования сущности, с которой в данный момент работает конструктор (текущей сущности). Панель содержит список атрибутов указанной сущности ([см. п. 3 настоящего руководства](#g30)) и служит для поиска нужных атрибутов и включения их в выражение.

Панель инструментов (средняя часть формы между панелью атрибутов и панелью условий) содержит кнопки, соответствующие различным элементам условия (виды операндов, операторы, функции). Кнопки панели инструментов описаны в таблицах, соответствующих видам элементов выражений:
* 	Табл. 2.1 Виды операндов выражений,
* 	Табл. 2.2 Операторы, используемые в выражениях,
* 	Табл. 2.3 Функции, используемые в выражениях.
 	
Кнопки двойных стрелок, появляющиеся в верхней и нижней части панели инструментов, служат для пролистывания панели инструментов, если она не помещается целиком в области формы. Двойной щелчок мышью на правом сплиттере автоматически устанавливает такой размер панели инструментов, чтобы на нем помещались все кнопки.

Панель выражения служит для отображения и редактирования выражения. Способ отображения и приемы работы с выражением описаны в п. 0. Начать создание выражения можно перетаскиванием элемента панели атрибутов или любого элемента панели инструментов конструктора.

Последовательность добавления элементов на панель редактирования выражений не имеет значения, т.к. добавленное условие в любой момент времени может быть отредактировано (изменены как операнды, так и операторы выражения).

В подпунктах настоящего раздела подробно описаны способ представления выражения и приемы работы с элементами логических выражений ([п.2.2.2.](#g31)). Далее описана работа с основными видами элементов: атрибут сущности ([п.2.3.1.](#g5)), константное значение ([п.2.3.2.](#g6)), параметр ([пп.2.3.3.](#g7) и [п.2.3.4](#g8)), скобки ([п.2.3.7.](#g14)), оператор ([п.2.3.5.](#g32)) и функция ([п.2.3.6.](#g33)).

Особенности применения некоторых операторов и функций описаны в соответствующих разделах:
* 	[п.2.4.](#g34) Применение отдельных операторов,
* 	[п.2.5.](#g35) Применение функций,
* 	[п.2.6.](#g29) Применение функций для работы с объектами.

### Графическое представление выражения

Операция может быть представлена двумя способами:
* 	«объемное» представление логической операции, т.е. использующей логический оператор «И»/«ИЛИ» (см. Рис.),
* 	универсальное представление операции (см. Рис.).

![38](/uploads/000003/38.jpg "38")  ![39](/uploads/000003/39.jpg "39")

Область операнда в свою очередь также может содержать выражение, представленное любым из вышеупомянутых видов, а также функцию. Т.е. описанные выше блоки могут быть вложенными друг в друга. Двойной клик мышью на пиктограмме логического оператора «И»/«ИЛИ» сворачивает конструкцию следующим образом: ![40](/uploads/000003/40.png "40") . Это может быть полезным при редактировании больших выражений сложной структуры.

Функция на панели редактирования может быть представлена одним из двух способов, представленных на Рис. В качестве аргумента функции может выступать другая функция или операция, возвращающая значение требуемого типа.

Для редактирования выражения, содержащего функцию, используются те же методы, что и в операциях: контекстное меню, двойной клик на аргументе функции, перетаскивание.


![41](/uploads/000003/41.jpg "41")  ![42](/uploads/000003/42.jpg "42")

Любой элемент выражения может быть выделен для произведения над ним какого-либо действия (например, для перемещения, удаления):
* 	щелчок мыши на обозначении (наименовании) операнда или оператора вызывает выделение этого операнда/оператора;
* 	щелчок мыши на области, выходящей за область наименования операнда, выделит все условие целиком.
 	
Выделенный элемент обозначается синей пунктирной рамкой, как это показано на Рис. Над выделенным элементом могут быть произведены действия – удаление, копирование, вставка (см. Табл. 2.5). Выделенный элемент также может перетаскиваться с помощью мыши в другие области условия. Если при этом удерживать нажатой клавишу [Ctrl] выбранный объект не перемещается, а копируется.

Некорректный элемент выражения (операция/функция с отсутствующим операндом/аргументом, с несовместимыми типами операндов, некорректный тип операнда/аргумента и т.д.) выделяется красной рамкой (см. Рис. 2.7).

![43](/uploads/000003/43.png "43") ![44](/uploads/000003/44.png "44")

Символ вопросительного знака «?» отображается на месте операнда/оператора/аргумента функции, если они не определены. Соответствующая область элемента выражения автоматически выделяется как некорректная и пользователю следует заполнить ее правильным значением. До тех пор, пока выражение содержит некорректные элементы, невозможно его применение и просмотр в виде XML-кода.

Все условные обозначения, применяемые на панели редактирования условия, представлены и описаны в Табл. 2.6.

|||
|:------------- |:---------------|
|![45](/uploads/000003/45.png "45") ![46](/uploads/000003/46.png "46")|Заголовок конструкции, содержащей один из логических операторов «И» или «ИЛИ».|
|![97](/uploads/000003/--97.png "97")|Пустой оператор или операнд. Сигнализирует о том, что данная область должна быть заполнена конкретным значением (оператором или операндом).|
|![98](/uploads/000003/--98.png "98")|Обозначение области элемента выражения (операции или операнда, функции или аргумента функции), щелчок на пиктограмме выделяет эту область.|
|![47](/uploads/000003/47.png "47") ![48](/uploads/000003/48.png "48")|Жирным шрифтом черного цвета выделяется заголовок (наименование) сущности или атрибута сущности, а также строка-приглашение к указанию сущности или атрибута.|
|![49](/uploads/000003/49.png "49") ![50](/uploads/000003/50.png "50")|Синим цветом текста выделяется константное значение любого типа, константное значение «Пусто» заключается в угловые скобки.|
|![51](/uploads/000003/51.png "51")|Черным шрифтом отображается заголовок параметра или функции. Клик на заголовке функции выделяет область этой функции.|
|![52](/uploads/000003/52.png "52")|Блок функции. Некоторые функции, имеющие сложную структуру, отображаются в выделенном блоке. Кнопка   в правом верхнем углу блока функции позволяет свернуть блок для более компактного отображения, при этом будет видна только первая строка блока функции. Кнопка   восстанавливает исходный размер блока.|
|![53](/uploads/000003/53.png "53")|Рамка выделения элемента выражения (оператора, операнда или выражения)|
|![54](/uploads/000003/54.png "54")|Рамка выделения некорректного элемента выражения|

## 	Работа с основными элементами выражения
### 	Атрибут

При перетаскивании мышью выбранного атрибута на панель редактирования выражений появляется диалог (см. Рис. 2.8), в котором отображается наименование атрибута, для которого необходимо выбрать оператор и константное значение, с которым будет сравнивается значение атрибута. Флажок «ПУСТО» позволяет задать условие, что значение атрибута должно быть пустым.

При добавлении условия на значение атрибута автоматически проверяется соответствие типа атрибута и введенного значения. При их несовпадении кнопка «ОК» диалога будет недоступна, т.е. сохранить некорректное условие нельзя. Для атрибутов логического типа вместо поля ввода будет отображаться переключатель «Да/Нет


![55](/uploads/000003/55.png "55") ![56](/uploads/000003/56.png "56")

После указания необходимых параметров и подтверждения с помощью кнопки «ОК», на панели выражения отобразится добавленное условие:
 
 ![57](/uploads/000003/57.png "57")
 
Перед добавлением следующего условия можно выбрать логический оператор, который будет объединять существующее условие с новым. Добавление нового условия без вставки логического оператора автоматически применит логический оператор «И». Результат такой операции представлен на рисунке:
 
 ![58](/uploads/000003/58.png "58")
 
В приведенном примере условие требует, чтобы наименование лекарственной формы имело значение «раствор» и при этом оригинальное наименование имело значение «хлоргексидин».

При необходимости изменить атрибут, уже добавленный в выражение, следует выбрать одно из описанных ниже действий:
* Удалить целиком условие, в которое включен данный атрибут (выделив мышью все выражение и нажав клавишу [Delete]) и добавить новое условие описанным выше способом.
* 	Сделать двойной клик мышью на заголовке атрибута, который следует изменить.
 	
При этом появится диалог выбора атрибута, список выбора которого повторяет содержимое панели атрибутов (см. Рис. 2.9).
* 	Выделить и удалить атрибут.

При удалении атрибута его область будет занята знаком «?» и выделена красной рамкой (см. Рис. 2.7 Пример выделения некорректных элементов выражения). Новый атрибут может быть вставлен в выражение перетаскиванием нужного элемента в область пустого атрибута (указатель мыши при отпускании кнопки должен быть установлен на область пустого атрибута).

Следует обратить внимание, что редактирование с помощью двойного клика не позволит изменить вид операнда, т.е. атрибут может быть заменен только на другой атрибут. Заменить атрибут на, например, константное значение, можно только с помощью перетаскивания мышью.

### 	Константное значение

В случае необходимости сравнить значение атрибута с некоторым постоянным, т.е. зафиксированным во время создания условия, значением, в выражении могут быть использованы т.н. константы. Константа – это величина, которая не меняется в процессе работы программы и ее значение задается один раз при создании условия. Константа может быть одного из допустимых типов данных ([см. п.1.2](#g4)), а также иметь пустое значение (такая константа имеет обозначение ![66](/uploads/000003/66.png "66") ).

Константа может быть добавлена перетаскиванием кнопки ![59](/uploads/000003/59.png "59")  в нужную область панели редактирования условия. При этом появляется диалог добавления константы, аналогичный представленному на Рис. 2.10. Диалог позволяет указать требуемый тип данных константы (выпадающий список справа) и значение константы – поле ввода слева. Поле ввода будет выглядеть по-разному для разных типов данных. Например, для ввода значения типа «Дата», в поле ввода доступна кнопка ![60](/uploads/000003/60.png "60") , открывающая элемент управления «Календарь», для логического типа данных вместо поля ввода отображается переключатель и т.д.

![61](/uploads/000003/61.png "61")

После подтверждения выбора кнопкой <OK> выбранное значение константы появляется на панели редактирования условия.
Значение константы может быть изменено одним из следующих способов:
* 	Двойной клик на области редактируемой константы, после которого на месте области операнда-константы появляются поля для указания нового значения:
 
 ![62](/uploads/000003/62.png "62")
 
При этом также может быть изменен тип константы (выпадающий список справа). После внесения изменений в поля редактирования нажатие клавиши [Enter] отображает сделанное изменение в выражении.

* 	Повторное перетаскивание кнопки «Константа» с панели инструментов в область элемента выражения, которую необходимо изменить. Это может быть как область уже существующей константы, так и область другого операнда выражения (например, атрибут может быть заменен на константу).

После внесения изменения любым из описанных способов автоматически производится проверка корректности выражения.

### 	Системный параметр

При создании условия могут быть применены т.н. системные параметры. Перечень доступных системных параметров и правила получения их значений устанавливаются разработчиком системы. Среди них наиболее употребительными являются:
* 	«Текущая дата» - параметр вычисляет значение текущей даты в момент применения параметра. Вычисленное значение используется при проверке условия (например, при наложении фильтра на данные).
* 	«Текущий пользователь» - вычисляет идентификатор пользователя системы на момент наложения условия.

Системному параметру на панели инструментов соответствует кнопка ![63](/uploads/000003/63.png "63") . Перетаскивание ее в нужную область панели редактирования условия (область операнда выражения) вызовет появление диалога, показанного на Рис. 2.11. Диалог запрашивает у пользователя выбор нужного системного параметра из предопределенного списка.

![64](/uploads/000003/64.png "64")

После подтверждения выбора в указанном элементе выражения появляется идентификатор указанного параметра. Например, в случае выбора параметра «Текущая дата»:

![65](/uploads/000003/65.png "65")
 
Независимо от даты создания такого условия, оно будет проверяться с учетом даты, текущей на момент вычисления результата выражения.

Ранее добавленный системный параметр может быть изменен так же, как и константное значение: либо двойным кликом на заголовке параметра, либо перетаскиванием значка системного параметра. Двойной клик открывает список выбора системного параметра.

Необходимо иметь в виду, что системный параметр возвращение значение типа «Объект», и в некоторых случаях требуется приведение значения системного параметра к нужному типу ([см. функцию приведения к типу п. 2.5.7](#g21)).

### 	Пользовательский параметр

Применение пользовательского параметра позволяет запросить значение параметра в момент вычисления значения выражения (например, в момент наложения фильтра на данные).

Для пользовательского параметра на панели инструментов предусмотрена кнопка ![3](/uploads/000003/3.png "3") . Перетаскивание данной кнопки в нужный элемент выражения вызывает появление диалогового окна, показанного на Рис. 2.12, в котором необходимо ввести наименование параметра. Это наименование увидит пользователь, когда будет применять данное условие. Поэтому важно правильно выбрать наименование, помогающее понять назначение данного параметра.

![67](/uploads/000003/67.png "67")

Пользовательский параметр в структуре условия отображается, как это показано на рисунке:
 
 ![68](/uploads/000003/68.png "68")
 
Ранее добавленный пользовательский параметр может быть изменен так же, как и константное значение: либо двойным кликом на заголовке параметра, либо перетаскиванием значка системного параметра. Двойной клик открывает поле редактирования для ввода нового наименования.

Значение добавленного таким образом параметра будет запрашиваться у пользователя системы с помощью диалога запроса параметров (см. Базовое руководство пользователя).

### 	Оператор

Оператор, как и атрибут сущности, может быть добавлен перетаскиванием мышью выбранного элемента панели инструментов (перечень операторов приведен в Табл. 2.2) на панель редактирования выражения. Эта операция вызывает создание на панели редактирования «заготовки» выражения, которая должна быть дополнена необходимыми операндами. При этом при перетаскивании логического оператора «И» или «ИЛИ» отобразится конструкция, представленная на Рис. 2.2, а для других операторов – конструкция, аналогичная показанной на Рис. 2.3, только в качестве операндов выражение будет содержать символы «?» и все элементы выражения будут выделены красной рамкой.

Далее следует заполнить недостающие элементы конструкции с помощью описанных в данном разделе руководства методов.

Редактирование оператора в выражении производится с помощью одного из двух способов:
* 	Перетаскивание нового оператора с панели инструментов в область оператора, который должен быть заменен.
* 	Использование контекстного меню оператора, которое включает список всех допустимых операторов, как это показано на рисунке справа. В этом списке символом «✓» выделен оператор, который должен быть заменен. Выбор из списка нового значения заменит старый оператор на новый.

![69](/uploads/000003/69.jpg "69")

При этом следует обратить внимание, что:
* 	оператор «Логическое И» (Логическое «ИЛИ») может быть заменен только на оператор этой группы, т.е. «И» на «ИЛИ» и наоборот (список операторов в контекстном меню будет содержать только два пункта «И» и «ИЛИ»);
* 	для операторов, возвращающих логическое значение («LIKE», «IN», «IS», «ExactIS»), в контекстном меню будет отображен дополнительный элемент «НЕ» ([см. п. 2.4.3](#g11)).
	
После вставки нового оператора выражение автоматически будет проверено на корректность, после чего его элементы могут оказаться выделенными красной рамкой. Это означает, что теперь должны быть скорректированы операнды выражения, либо выбран новый оператор.

Арифметические операторы (такие как сложение, вычитание и т.д.), и соответственно, арифметические выражения, могут быть использованы в конструкторе в качестве элементов логического выражения. Это требуется в том случае, когда необходимо сравнение значения атрибута/константы со значением, вычисляемым на основании значений других атрибутов/ констант.
Полный перечень операторов приведен в Табл. 2.2 настоящего руководства, описание отдельных операторов – в [п. 2.4.](#g34)

### 	Функция

Функция, как и другие элементы выражения, может быть добавлена в выражение путем перетаскивания мышью соответствующей кнопки панели инструментов в нужную область панели редактирования условия. Добавление функции создает шаблон функции, похожий на один из представленных на рисунке: ![70](/uploads/000003/70.png "70")
  или ![71](/uploads/000003/71.png "71") .
	
Шаблон содержит текст, соответствующий заголовку выбранной функции, и поля аргументов функции, которые автоматически заполняются символом «?». В качестве аргумента функции может выступать любой элемент из перечисленных в Табл. 2.1, а также операция или функция, возвращающая значение требуемого типа. Вставить нужный элемент можно путем его перетаскивания в область аргумента функции.

Двойной клик на пустом аргументе функции (содержащем символ «?») откроет поля для заполнения аргумента константным значением или диалог выбора соответствующего элемента из списка. Редактирование аргументов функции производится теми же способами, что и операнды выражения – двойной клик, перетаскивание.

Контекстное меню функции, содержащие доступные опции применения функции, открывается щелчком правой кнопки мыши на заголовке функции (подробное описание функций и содержимого контекстных меню приведено в описаниях функций [подраздела 2.5](#g35)).

### 	Применение скобок

Скобки позволяют управлять порядком произведения вычислений точно так же, как это делают скобки, используемые в математических формулах. Скобки добавляются перетаскиванием кнопки  ![17](/uploads/000003/17.png "17") панели инструментов конструктора в нужную область условия. Область между скобками автоматически заполняется символом «?», на место которого может быть вставлено любое выражение.

## Применение отдельных операторов

### 	Оператор LIKE

В отличие от оператора равенства (![7](/uploads/000003/7.png "7") ) оператор LIKE позволяет определять частичное совпадение текстовых строк. При этом можно использовать символы шаблона, приведенные в Табл. 2.7.

|||
|:------------- |:---------------|
|%	|Любая строка длиной нуль и более символов. Например, удовлетворяющими условию «%больница%» признаются значения, содержащие строку «больница»:<br>-«ГУЗ Больница №5»<br>-«Больница»<br>-«1-я больница»<br>-«Больница №1» и т.д.|
|_	|Любой одиночный символ. Например, выражению «О_О» будут удовлетворять все строки, где между буквами «О» располагается любой один символ: «ООО», «ОАО», «О1О» и т.д. Но такая строка, как «ОО», уже не подойдет под это условие.|
|[]	|Любой одиночный символ, содержащийся в диапазоне или наборе. Диапазон может быть задан, как «0-3» (т.е. любой символ из перечня символов, идущих по порядку 0,1,2,3), «а-в» (а,б,в) и т.д.<br>Набор символов задается строкой: «0126», «ацдб» и т.д.<br>Пример: «больница №[1-2]» – подойдут строки «больница №1» и «больница №2».|
|[^]	|Применение шаблона аналогично предыдущему, с той разницей, что удовлетворять условию будут символы, НЕ входящие в указанную последовательность.<br>Пример: «больница №[^1-2]» – подойдут строки, где больница не имеет номер 1 или 2: «больница №8» и «больница №6».|

### 	Оператор IN
Оператор возвращает результат проверки вхождения значения первого операнда в перечисление, указанное во втором операнде. Исходный вид выражения с использованием оператора показан на рисунке: ![72](/uploads/000003/72.png "72") . Операнды могут быть указаны путем перетаскивания нужных элементов с панелей инструментов и атрибутов в область соответствующего операнда. Причем перетаскивание на одну из скобок добавляет новый элемент перечисления, а перетаскивание в область элемента перечисления заменяет этот элемент. Одно константное значение может быть введено после двойного клика на области операнда.

Перечисление может состоять из элементов различных типов. Это может быть как перечисление, состоящее из констант, атрибутов, параметров; так и атрибут-коллекция или функция, возвращающая коллекцию значений (например, функции «Условие» или «Выбрать»).

Пример условия с использованием оператора IN:  ![73](/uploads/000003/73.png "73").

Оператор доступен только в контекстном меню при редактировании уже существующего выражения.


### 	Оператор «Не»

Оператор инвертирует значение операнда – логического значения или выражения и доступен в контекстном меню логических операторов «LIKE», «IN», «IS», «ExactIS». Пример использования оператора «Не»:![74](/uploads/000003/74.png "74") .

### 	Оператор IS

Оператор связан с отношениями наследования между сущностями ([п. 1.1.](#g36)) и позволяет анализировать, на какую именно сущность из дерева наследования указывает атрибут-ссылка.

Для того чтобы включить данный оператор в выражение, нужно сначала перетащить на панель редактирования любой другой оператор (например,![7](/uploads/000003/7.png "7")  ) и в контекстном меню оператора выбрать пункт <IS>. Выражение при этом примет вид, показанный на рисунке:
 
 ![75](/uploads/000003/75.png "75")
 
По умолчанию в области первого операнда выражения отображается наименование текущей сущности в скобках. При этом область операнда выделена красной рамкой, что означает необходимость выбрать корректный объект. В данном случае корректным объектом будет являться атрибут, соответствующий ссылке на родительскую сущность. Выбор атрибута производится двойным щелчком на имени сущности. Форма диалога выбора атрибута показана на Рис. 2.9., в списке необходимо выбрать атрибут-ссылку на родительскую сущность, имеющий пиктограмму ![76](/uploads/000003/76.png "76") .

Затем в области второго операнда необходимо указать сущность, на которую должен указывать атрибут. Операция возвращает положительное значение, если атрибут-ссылка содержит идентификатор экземпляра указанной сущности или любой сущности-потомка указанной сущности.

См. также выражения, связанные с отношениями наследования – оператор «ExactIS» ([п. 2.4.5](#g13)), функция «Поиск по дереву» ([п. 2.6.4.](#g27)).

### 	Оператор ExactIS

Действие оператора аналогично действию оператора «IS» ([п. 2.4.4](#g12)) с той разницей, что «ExactIS» возвращает положительное значение только в том случае, если атрибут-ссылка указывает именно на ту сущность, которая задана во втором операнде. Т.е. ссылка на сущность-наследника игнорируется.

## 	Применение функций

### 	Функция разности дат

Часто возникает необходимость вычисления разности значений типа «Дата». Например, разницу в годах между текущей датой и датой рождения пациента, разницу в днях между текущей датой и датой начала месяца и т.д. Для этого предусмотрена функция разности дат, которой на панели инструментов конструктора соответствует кнопка ![18](/uploads/000003/18.png "18") . Значок функции может быть перетащен с помощью мыши в область операнда выражения. При этом в области операнда появляются новые элементы:
 
 ![77](/uploads/000003/77.png "77")
 
Далее по правой кнопке мыши (в контекстном меню) на заголовке функции (текст «Разница в годах между») может быть выбрана единица измерения, в которой требуется вычислить разность:
* 	год (устанавливается автоматически),
* 	квартал,
* 	месяц,
* 	день,
* 	час,
* 	минута, секунда и миллисекунда.

Также вместо символов «?», установленных в области аргументов функции, должны быть указаны либо константные значения дат (двойной клик на области аргумента), либо атрибут или параметр, имеющие тип «Дата».
Функция возвращает количество полных единиц (полных лет, целых дней  и т.д.), вмещающихся в указанный период. Например, разность между датами 20.12.2014 и 10.01.2015 составит 0 полных лет.
Применяя эту функцию необходимо иметь в виду, что вторая по порядку дата вычитается из первой, т.е. если первая дата будет меньше второй, результат будет отрицательным. Если при формировании условия нет уверенности в том, что первая по порядку дата обязательно будет больше второй, к результату данной функции следует применить функцию вычисления абсолютного значения ([см. п. 2.5.2.](#g16)), чтобы исключить ошибки при обработке результата вычисления функции.

### 	Функция «Прибавить к дате»

Для вычисления даты, отстоящей от заданной на определенное количество временных периодов (лет, месяцев, дней и т.д.) предназначена функция «Прибавить к дате»:

 ![78](/uploads/000003/78.png "78")
 
Контекстное меню функции содержит список допустимых временных периодов, аналогичный списку периодов в функции «Разность дат» ([см. п. 2.5.1](#g15)). Первым аргументом данной функции является количество временных периодов указанного вида, вторым – дата, к значению которой будет прибавляться указанный период времени.

### 	Функция получения части даты

При необходимости использовать в выражении определенную часть даты (год, месяц или число по отдельности) можно использовать функцию «Получить часть даты» (кнопка ![79](/uploads/000003/79.png "79")  панели инструментов). Исходный вид функции после перетаскивания на панель редактирования:  . Требуемая часть даты выбирается из контекстного меню функции:
* 	год,
* 	квартал,
* 	месяц (порядковый номер в рамках года),
* 	день года (порядковый номер в рамках года),
* 	неделя (порядковый номер в рамках года),
* 	день недели (порядковый номер в рамках недели),
* 	день (порядковый номер в рамках месяца),
* 	час (порядковый номер в рамках суток),
* 	минута (порядковый номер в рамках суток),
* 	секунда (порядковый номер в рамках суток).

Тип возвращаемого значения – целое число.

### 	Функция получения подстроки

В том случае, когда необходимо вычленить какую-либо часть текстовой строки (например, код территории из единого номера полиса пациента), можно применить функцию получения подстроки. Функции соответствует кнопка ![21](/uploads/000003/21.png "21") панели инструментов конструктора условий. Функция имеет вид: ![82](/uploads/000003/82.png "82") , где 
* 	первый аргумент функции – исходная строка, часть которой требуется извлечь,
* 	второй – порядковый номер позиции (символа), с которой начинается нужный фрагмент,
* 	третий – длина нужного фрагмента в символах.

Нумерация символов в строке начинается с 0. Пример наложения условия на номер полиса, включающего функцию подстроки:

![83](/uploads/000003/83.png "83")

### 	Функция вычисления длины строки

Функция ( ![22](/uploads/000003/22.png "22")) определяет длину в символах указанной в аргументе функции строки ![84](/uploads/000003/84.png "84")  . Пример условия с использованием данной функции:
![85](/uploads/000003/85.png "85") .

### 	Функция ABS

Блок математических функций, в который входит функция ABS, представлен на панели инструментов кнопкой ![23](/uploads/000003/23.png "23") . Перетаскивание кнопки на панель редактирования автоматически вставляет функцию «Число π». Изменить вид функции можно в контекстном меню заголовка функции. В списке доступных функций контекстного меню следует выбрать функцию <ABS>, после чего функция примет вид:
 
 ![86](/uploads/000003/86.png "86")
 
В область аргумента может быть вставлен любой элемент, значение которого имеет числовой тип.

### 	Функция приведения типов

Функция применяется в тех случаях, когда необходимо преобразовать значение какого-либо элемента выражения к другому типу. Например, любой системный параметр, в т.ч. «Текущая дата» имеет тип «Объект». Т.е. для того, чтобы использовать его в выражении, анализирующем даты, требуется приведение значения параметра к типу «Дата».

В панели инструментов функции соответствует кнопка ![24](/uploads/000003/24.png "24")  . Результат помещения функции на панель редактирования условия выглядит так:  ![87](/uploads/000003/87.png "87"). Тип данных, к которому необходимо привести значение, выбирается в контекстном меню функции (список возможных типов соответствует типам, перечисленным в [п. 1.2](#g4)).
Пример корректно оформленной функции:
 ![88](/uploads/000003/88.png "88") .
 
### 	Функция «Удовлетворяет выражению»

Функция позволяет анализировать значение аргумента функции (атрибута или параметра) с помощью регулярных выражений. Изначально функция на панели редактирования выражения имеет вид: ![89](/uploads/000003/89.png "89") , где первый аргумент функции – это текстовая строка регулярного выражения (при двойном щелчке мышью открывается окошко редактирования, в котором нужно ввести строку), второй – анализируемое значение, который заполняется перетаскиванием нужного элемента из списка атрибутов или панели инструментов. Пример корректно заполненной функции:
 
 ![90](/uploads/000003/90.png "90")
 
Функция возвращает целое число, соответствующее числу вхождений шаблона, заданного в регулярном выражении, в текстовую строку второго аргумента функции.

Описание синтаксиса регулярных выражений выходит за рамки данного Руководства.

### 	Функция «Условие»

Функция «Условие» (кнопка ![91](/uploads/000003/91.png "91")  ) позволяет включить в выражение конструкцию проверки условия вида «Если ВЫРАЖЕНИЕ тогда ЗНАЧЕНИЕ1, иначе ЗНАЧЕНИЕ2». ВЫРАЖЕНИЕ должно возвращать логическое значение, и если оно положительное, функция возвращает ЗНАЧЕНИЕ1, если условие не выполняется –ЗНАЧЕНИЕ2.
Перетаскивание элемента на панель редактирования выражения создает блок функции, как это показано на рисунке:

![92](/uploads/000003/92.png "92")

Все аргументы функции могут быть созданы перетаскиванием нужных элементов в область аргумента. Значения аргументов, соответствующих возвращаемому значению, могут быть заполнены константным значением с помощью двойного клика на области аргумента. Возвращаемое значение (аргументы функции «Тогда» и «Иначе») может быть константой, значением атрибута, параметра, результатом вычисления функции или выражением, но не может быть коллекцией (перетащить атрибут child-коллекции в поле возвращаемого значения нельзя).

Кнопка   позволяет добавить еще одну конструкцию «Если … тогда …» (  - скрыть, т.е. удалить ненужное условие ). Таким образом, функция позволяет проанализировать ряд условий и в зависимости от того, какое из них выполнено, вернуть определенный результат.

Пример условной конструкции приведен на рисунке:
 
 ![93](/uploads/000003/93.png "93")
 
Жесткого требования по совпадению типов возвращаемых значений «Тогда» и «Иначе» нет, т.к. это зависит от той процедуры, которая будет обрабатывать результат выполнения функции, но следует иметь в виду, что если возвращаемые значения не могут быть автоматически приведены к одному типу, возможна ошибка при обработке результата функции. Т.е. если результат функции анализируется в рамках создаваемого с помощью конструктора выражения, необходимо следить, чтобы возвращаемые значения имели тот тип, который ожидает функция или выражение, в которое включена условная конструкция. Пример анализа результата функции в выражении:

![94](/uploads/000003/94.png "94")


## 	Применение функций для работы с объектами

### 	Функция «Количество элементов в коллекции»

Вставка функции на панель редактирования выражения вызывает появление блока, показанного на рисунке:
 
 ![95](/uploads/000003/95.png "95")
 
В месте расположения аргумента функции отображается приглашение для выбора аргумента. Двойной клик мышью открывает диалог выбора коллекции, показанный на Рис. 2.13. Перетаскивание с панели атрибутов в случае данной функции не применяется.

![96](/uploads/000003/96.png "96")
 
Диалог содержит список атрибутов (см. п.3 Руководства), в котором видны только атрибуты, являющиеся коллекциями. Из списка необходимо выбрать атрибут, соответствующий child-сущности (значок ![97](/uploads/000003/97.png "97") , [см. раздел 1.1 Руководства](#g36)).

Можно также наложить условие, при выполнении которого элементы выборки будут включаться в расчет. Это можно сделать перетаскиванием в область блока функции любого элемента или готового выражения. При наведении указателя мыши на блок функции появляется дополнительный элемент – блок условия. Перетаскиваемый элемент необходимо «бросить» на этот дополнительный элемент  с заголовком «Такие, что:», как это показано на рисунке:
 
 ![98](/uploads/000003/98.png "98")
 
На рисунке ниже показан пример функции с наложением условия на элементы выборки:
 
 ![99](/uploads/000003/99.png "99")
 
Функция вернет целое число, соответствующее количеству элементов коллекции, т.е. количество экземпляров child-сущности, содержащих ссылку на определенную запись parent-сущности.

### 	Функция «Выбрать»

Функция позволяет сделать выборку из значений определенной сущности по заданным правилам.
После добавления функции на панель редактирования выражения создается блок, показанный на рисунке:

![100](/uploads/000003/100.png "100")

Слово «Первый» соответствует опции отбора значений по умолчанию и означает, что нужно отобрать один первый по порядку элемент из коллекции экземпляров сущности. Другие варианты доступны для выбора с помощью контекстного меню, как это показано на Рис. 2.14.

Опция «ВСЕ» соответствует отбору всех экземпляров сущности. Опция «Другое» позволяет указать конкретное количество элементов выборки с помощью диалога (Рис. 2.15). В этом случае будут отобраны первые элементы выборки в указанном количестве, например, первые 10.

![101](/uploads/000003/101.png "101") ![102](/uploads/000003/102.png "102")
 

Выбор сущности производится с помощью строки-приглашения «Выберите имя сущности…», двойной клик на которой открывает список выбора, показанный на Рис. 2.16. Диалог содержит стандартную табличную форму и функции поиска нужного элемента в перечне сущностей системы (см. Базовое руководство пользователя).
После выбора сущности нужно указать атрибут, значение которого будет включено в выборку. Для этого двойным щелчком в области первого аргумента функции следует открыть диалог выбора атрибута указанной сущности, показанный на Рис. 2.17.
 
![104](/uploads/000003/104.png "104") ![105](/uploads/000003/105.png "105")

После выбора сущности и пока блок функции находится в фокусе, панель атрибутов отображает список атрибутов сущности, указанной в функции. Соответственно, нужный атрибут может быть указан с помощью перетаскивания с панели атрибутов.

В данную функцию может добавлено условие отбора элементов и правило сортировки элементов в коллекции. Это можно сделать перетаскиванием в область блока функции любого элемента или готового выражения. При наведении указателя мыши на блок функции появляются два дополнительных элемента – блок условия и блок сортировки, как это показано на Рис. 2.18:
 
![106](/uploads/000003/106.png "106") ![107](/uploads/000003/107.png "107")
 
Для создания условия отбора перетаскиваемый элемент необходимо «бросить» на блок условия с заголовком «Такие, что:». Вновь добавленное выражение редактируется по правилам, описанным в настоящем разделе руководства.

Для указания правила сортировки необходимо перетащить нужный атрибут на блок сортировки («Сортировать по:»). Пример результата такой операции показан на Рис. 2.19. В правой части поля с наименованием атрибута, по которому производится сортировка, располагается элемент управления с изображением стрелки, показывающий порядок сортировки. Изменить порядок можно двойным кликом по стрелке.

Таким образом, функция возвращает коллекцию значений определенного атрибута указанной сущности или значение <ПУСТО>, если не найден ни один элемент. Коллекция может быть использована для поиска в ней определенного значения и т.д.

### 	Функция «Существует»

Функция позволяет проверить факт существования данных сущности, удовлетворяющих определенным условиям. Изначальный вид блока функции показан на рисунке:

![109](/uploads/000003/109.png "109")

Двойной щелчок на приглашении «Выберите имя сущности…» открывает диалог выбора сущности, показанный на Рис. 2.16. Контекстное меню заголовка функции кроме опции по умолчанию «Существует» позволяет выбрать опцию «Не существует» (см. Рис. 2.20).
 
![110](/uploads/000003/110.png "110") ![111](/uploads/000003/111.png "111") 

После выбора сущности и пока блок функции находится в фокусе, панель атрибутов отображает список атрибутов сущности, указанной в функции.

Следующим шагом нужно наложить условие на данные указанной сущности. Это можно сделать путем перетаскивания нужного элемента панелей инструментов или атрибутов на блок функции. В результате этого действия в блоке функции появляется дополнительная секция условия, как это показано на Рис. 2.21. Дополнительная секция должна содержать логическое выражение условия, накладываемого на значение (значения) указанной сущности.

### 	Функция «Поиск по дереву»
Под деревом имеется в виду дерево наследования, т.е. данная функция позволяет анализировать отношения наследования сущности ([о наследовании сущностей см. п.1.1 Руководства.](#g36)). Исходный вид блока, соответствующего функции, показан на Рис. 2.22.
 
![112](/uploads/000003/112.png "112")![113](/uploads/000003/113.png "113")

По умолчанию для функции устанавливается опция поиска сущностей-предков. Это может быть изменено с помощью контекстного меню функции, показанного на Рис. 2.23.

Автоматически в качестве аргумента функции устанавливается сущность из текущего контекста. Двойной клик на области аргумента (который на рисунке содержит подпись «текущий сущности») открывает диалог выбора атрибута (см. Рис. 2.17). Из списка атрибутов можно выбрать атрибут-ссылку (значок ![114](/uploads/000003/114.png "114") ). В этом случае функция будет анализировать наличие сущностей-предков (потомков) для сущности, на которую указывает атрибут.

Числовые параметры «Не ближе чем…» и «Не дальше чем…» позволяют указать глубину поиска. Т.е. значение «Не ближе чем 2» и «Не дальше чем 3) будет означать, что поиск будет охватывать вторую и третью ступени в иерархии наследования вверх – в случае поиска предков, вниз – в случае поиска потомков.

Функция также позволяет включить дополнительное условие поиска, как это описано для функции «Количество элементов в коллекции» ([п. 2.6.1](#g24)).

## 	Команда «Упорядочить параметры»

Если в выражении используется большое количество пользовательских параметров ([см.п. 2.3.4](#g8)) существует возможность настраивать порядок их ввода для удобства пользователя – например, их можно сгруппировать по типам. Для этого предназначена кнопка  ![115](/uploads/000003/115.png "115") управляющей панели генератора. Эта кнопка доступна, только если в редактируемом выражении присутствуют пользовательские параметры.

![116](/uploads/000003/116.png "116")

Нажатие на кнопку вызывает появление диалога, показанного на Рис. 2.24. Диалог содержит список всех параметров с указанием индекса и наименования. Переключатель в верхней части формы служит для выбора метода настройки:
* 	Автоматически: позволяет управлять порядком элементов в списке с помощью кнопок  / , т.е. выделенный в списке элемент перемещается кнопками на одну позицию вверх или вниз;	 
Рис. 2.24 Диалог настройки списка
пользовательских параметров
* 	Вручную: для выделенного в списке элемента его порядковый номер задается целым числом в поле ввода справа от списка.
 	
После нажатия кнопки <OK> установленный порядок сохраняется и диалог закрывается. В окне диалога запроса параметров у пользователя (см. Базовое руководство пользователя) параметры в списке будут расположены в указанном порядке и последовательность заполнения будет соответствовать этому порядку.

## 	Окно редактирования XML

Переход в режим создания условий с помощью языка XML включается кнопкой ![117](/uploads/000003/117.jpg "117")  на управляющей панели формы. При этом область формы ниже управляющей панели занимает поле редактирования текста, в котором пользователь может самостоятельно набрать XML-код (см. Рис. 2.25).

![118](/uploads/000003/118.png "118")

Этот же режим может быть использован для просмотра XML-кода условия, созданного с помощью графического конструктора.
Созданный в этом окне код может быть сохранен с помощью кнопки ![117](/uploads/000003/117.png "117")  в виде файла XML. Содержимое ранее сохраненного файла может быть загружено в окно редактирования с помощью кнопки ![119](/uploads/000003/119.png "119") .	 

Переключение в режим отображения XML-кода невозможно, если выражение содержит ошибки, т.е. некорректные элементы. Приложение при этом выдает сообщение об ошибке. Возможность перехода в XML-редактор появится, если временно отключить режим проверки корректности выражения кнопкой ![120](/uploads/000003/120.png "120")  управляющей панели генератора выражений. При этом некорректные элементы выражения не будут включены в XML-код.

Режим проверки корректности автоматически включается после перехода в режим конструктора и внесения любого изменения в выражение.

# 	Форма списка атрибутов сущности

Список атрибутов сущности является универсальным элементом интерфейса системы и используется в формах, где требуется выбор атрибута (например, настройка отображения колонок в табличной форме и т.д.).
Список атрибутов сущности отображается в виде древовидного списка, как это показано на Рис. 3.1.

![122](/uploads/000003/122.png "122")

Атрибуты в списке сортируются по наименованию и снабжены пиктограммами, соответствующими виду атрибута. Кроме того, элемент дерева может быть выделен цветом. Условные обозначения для элементов дерева приведены в Табл. 3.1.

Следует иметь в виду, что некоторые виды атрибутов могут отсутствовать в текущем контексте отображения списка. Например, child-коллекции не отображаются в списке, используемом для настройки колонок табличной формы.

|Обозначение|Описание|
|:------------- |:---------------|
|![123](/uploads/000003/123.png "123")|Простой атрибут, содержащий текстовое, числовое и др. значение (не ссылка на другую сущность), описывающее экземпляр сущности. Например, «Фамилия», «Наименование организации» и т.п.|
|![124](/uploads/000003/124.png "124")|Атрибут-ссылка на parent-сущность. Такой элемент списка имеет вложенные элементы, соответствующие атрибутам parent-сущности. Например, сущность «Медицинская организация» имеет атрибут-ссылку на справочник ОКОПФ, сущность «Справочник ОКОПФ», в свою очередь, имеет атрибуты «Код», «Наименование» и т.д. Список этих атрибутов отобразится в виде подчиненных элементов при раскрытии узла дерева, соответствующего атрибуту-ссылке.|
|![125](/uploads/000003/125.png "125")|Атрибут, представляющий собой коллекцию объектов (элементов с типом «Объект») –экземпляров child-сущности, имеющей ссылку на данную сущность (child-коллекция).<br>Например, есть сущность «Элемент накладной», которая ссылается на сущность «Накладная». Соответственно сущность «Накладная» будет иметь атрибут «Элемент накладной», содержащий коллекцию элементов накладной.<br>Вложенные элементы атрибута такого типа будут содержать атрибуты child-сущности.|
|![126](/uploads/000003/126.png "126") ![127](/uploads/000003/127.png "127")|Элемент, соответствующий производной сущности (сущности-наследнику, [см.п. 1.1.](#g36) Руководства).Заголовок элемента – это наименование производной сущности.<br>Вложенные элементы представляют набор атрибутов сущности-наследника. Которые, в свою очередь, также могут содержать элементы производных сущностей следующего порядка.Заголовок элемента отображается серым цветом.|
|![128](/uploads/000003/128.png "128")|Светло-синим цветом выделяются вычисляемые атрибуты.|
|![129](/uploads/000003/129.png "129")|Фиолетовым цветом заголовка выделяются пользовательские атрибуты.|



