<!-- TITLE: Обслуживание базы данных -->
<!-- SUBTITLE: Руководство администратора -->

# 	Профилакические работы

Для исключения нестабильности в работе системы «Медэксперт-ТФОМС» необходимо взависимости от нагрузки БД(контролируется системный администратором БД) проводить переиндексацию БД.

## 	Переиндексация БД

Для проведения переиндексации БД системы «Медэксперт – ТФОМС» необходимо выполнить следующую команду запроса в SQL сервере-New query(Новый запрос)

```USE IESDB
GO
DECLARE @TableName VARCHAR(255)
DECLARE @sql NVARCHAR(500)
DECLARE @fillfactor INT
SET @fillfactor = 80
DECLARE TableCursor CURSOR FOR
SELECT OBJECT_SCHEMA_NAME([object_id])+'.'+name AS TableName
FROM sys.tables
OPEN TableCursor
FETCH NEXT FROM TableCursor INTO @TableName
WHILE @@FETCH_STATUS = 0
BEGIN
SET @sql = 'ALTER INDEX ALL ON ' + @TableName + ' REBUILD WITH (FILLFACTOR = ' + CONVERT(VARCHAR(3),@fillfactor) + ')'
EXEC (@sql)
FETCH NEXT FROM TableCursor INTO @TableName
END
CLOSE TableCursor
DEALLOCATE TableCursor
GO
```

# 	Резервное копирование базы данных
С целью восстановления сведений при невозможности исправления данных после аварийной ситуации(см.пункт3),необходимо заранее настроить в базе SQL  IESDB ежедневное резервное копирование БД.

## Создание bukup (пошаговая инструкция)

1. Запустить SQL Management Studio (Путь к файлу: Пуск – Программы - Microsoft SQL Server 2008 R2 - SQL Management Studio). Ввести Имя сервера, Логин и Пароль.

 

2. По «+» развернуть компоненты SQL-сервера, найти и развернуть комоненты службы SQL Server Agent.

 

3. 2. По «+» развернуть службу Задания, выделив и щелкнув по ней правой кнопкой мыши выбрать пункт Создать задание. 

 

 
4. В открывшимся окне на вкладке General необходимо задать Имя Задания, остальное по умолчанию, как на рисунке.

 
 
5. Перейти на вкладку Steps. Создать новый Шаг, нажав New.

 


 
6. В открывшемся окне на вкладке General необходимо задать произвольное Имя, выбрать Тип – Transact-SQL script (T-SQL). Далее необходмо выбрать из списка базу данных, для которой будет назначено задание по созданию автоматического бэкапа. Затем необходимо вставить следующую команду:

```declare @a varchar (255)
declare @b datetime
set @b = cast(cast(cast(getdate() as int) as float) as datetime)
set @a = 'D:\Backup\Bmicro\' + 'umb' + '_' +(cast (datepart(day,@b) as varchar))+'.'+(cast (datepart(month,@b) as varchar))+'.'+(cast (datepart(year,@b) as varchar)) + '.bak'
BACKUP DATABASE umb3_test
TO DISK = @a
```

Расшифровка:
Команда стандартная по умолчанию, заменить необходимо только те записи, которые выделены желтым маркером.
D:\Backup\Bmicro\ - путь, куда будет выгружаться бэкап базы данных
umb - имя бэкапа (созданный файл бэкапа будет выглядеть следующим образом: umb _27.05.2011.bak)
umb3_test - название базы данных


 



7. Перейти на вкладку Advanced и выбрать пути решения в случае успешного создания бэкапа и в случае ошибки при его создании (рекомендуется как на скриншоте).  Нажать ОК.

 
 
8.  Перейти на вкладку Schedules. Создать новое Расписание, нажав New.

 
 
9. Задать произвольное Имя расписания, выбрать Тип – Recurring, поставить галку Enabled. Далее выбрать необходимую Периодичность, время создания и сроки выполнения Задания. Нажать ОК.

 
 
10.  Нажать ОК.

 

Примечание: Далее необходимо проверять, чтобы была запущена служба SQL Server Agent после перезагрузок или сбоев сервера, а также проверить автосоздание бэкапов в указанную папку. 





# 	Аварийная ситуация

## 	В случае аварийной ситуации

( экстренное(незаплонированое) выключение питание сервера) и при дальнейшем запуске программы обнаружены ошибки в работе БД, необходимо выполнить следующую команду запроса в SQL сервере-New query(Новый запрос)
```
dbcc checkdb
GO
```
При обнаружении ошибок в БД в ручном режиме производить востановление целостности БД или произвести восстановления БД из последнего ранее созданно backup.
