<!-- TITLE: Управляющие инструкции -->
<!-- SUBTITLE: Руководство пользователя системы «ВИТАКОР»-->

Выходной документ формируется по шаблону. Шаблон – это документ того же формата, что и выходной документ, в котором содержатся инструкции генератора отчетов GEst. Набором представленных в шаблоне инструкций определяется какие атрибуты и коллекции объектовпопадут в отчет. Инструкции в теле шаблона обрамляются строкой "%%", кроме шаблонов в формате MS Word XML Document.

```%%{User/Name}%%```

Для шаблонов MS Word XML Document используется набор кастомных xml тэгов, которые размещаются в теле шаблона.

Поддерживается два типа инструкций:
* 	управляющие инструкции, 
* 	инструкции вывода значений. 
 	
Первые используются для организации циклов, для группировок объектов по значениям атрибутов и т.п., вторые - для непосредственного вывода значений в выходной документ (атрибуты объектов, вычислимые атрибуты генератора отчетов).

Вставка инструкций в шаблоны производится либо вручную, либо средствами библиотеки. Поддерживается автоматическая генерация шаблона из GUI генератора отчетов (см. "Генератор отчетов руководство пользователя") и вставка инструкций в приложениях MS Office (см. "MS Office add-in генерации шаблонов отчетных документов").

Управляющие инструкции
Управляющие инструкции разбивают шаблон на области. В зависимости от типа инструкции, ограниченная ею область либо выводится в отчет несколько раз (#xsl:for-each), либо выводится в отчет по условуию (#xsl:if) и т.п.. Генератор разбирает файл шаблона, отыскивает в нем управляющие инструкции и выводит данные объектов в соответствии с ними.

# Управляющие инструкции

Управляющие инструкции разбивают шаблон на области. В зависимости от типа инструкции, ограниченная ею область либо выводится в отчет несколько раз (#xsl:for-each), либо выводится в отчет по условуию (#xsl:if) и т.п.. Генератор разбирает файл шаблона, отыскивает в нем управляющие инструкции и выводит данные объектов в соответствии с ними.

## Инструкция циклического блока (#xsl:for-each)

```%%#xsl:for-each select='Path1' sort='Path2;Path3' filter='Lexem' minCount='5' maxCount='10'%%```

Атрибут1: ```%%Path4%%```

Атрибут2: ```%%Path5%%```

```%%#xsl:end%%```

Инструкция предназначена для организации цикла по коллекции объектов. Инструкция задается командами: ```#xsl:for-each``` – начало тела цикла и ```#xsl:end``` – конец тела цикла. Фрагмент документа, заключенный между ними повторяется в выходном документе столько раз, сколько объектов, удовлетворяющих параметрам управляющей инструкции, содержится в коллекции. Инструкция ```#xsl:for-each``` имеет один обязательный параметр – ```select```.

Параметры поддерживаемые управляющей инструкцией:
```select='путь_к_коллекции'```. Обязательный параметр. Указывает по какой коллекции текущего объекта будет производится цикл. Допускается в качестве пути к коллекции указание – {*}, что означает цикл по элементам текущей коллекции. 

```sort='перечень_путей'```. Указывает сортировку, заданную внутри цикла для выводимой в цикле коллекции. Может содержать один, или более путей к атрибутам. Пути к атрибутам разделяются точкой с запятой(«;») Например, ```sort='{путь_к_атрибуту1};{путь_к_атрибуту2}'```. В итоге коллекция объектов, выводимая в цикле будет отсортирована сначала по первому атрибуту, затем по второму. 

```filter='представление_лексемы'```. Указывает применяемый в памяти фильтр к объектам коллекции. Если текущий элемент не удовлетворяет заданному фильтру, то тело цикла для этого объекта не выводится. 

```minCount='целое_число'```. Задает наименьшее количество итераций которое должно быть выполнено инструкцией циклического блока. Значение должно быть меньше maxCount. Параметр используется, например, когда выходной документ должен содержать повторяющийся блок вне зависимости от того есть ли объекты в коллекции. В этом случае блок повторяется в документе указанное количество раз с пустыми значениями содержащихся в нем управляющих инструкций. 

```maxCount='целое_число'```. Задает максимально возможное число итераций выполняемых инструкцией циклического блока. Значение должно быть больше minCount. 

Для MS Word XML Document шаблонов элемент foreach.

## Группировка коллекции (#xsl:group-by)

Инструкция группирует объекты по значениям заданного набора атрибутов. Группировка объектов задается командами: ```#xsl:group-by``` – начало тела группировки и ```#xsl:end``` – конец группировки. Так же как и для ```for-each``` можно задается

* 	```select='путь_к_группируемой_коллекции'``` – обязательный параметр; 
* 	```sort='перечень_путей'```; 
* 	```filter='представление_лексемы'```. 
* 	```paths='перечень_путей'``` - обязательный параметр, перечень путей к атрибутам, по которым производится группировка объектов. 

В group-by необходимо вложить несколько пар ```#xsl:for-each ... #xsl:end```. Их количество на единицу больше числа атрибутов группировки. Первая вложенная пара образует цикл по группам, образованным значениями первого атрибута группировки, вторая – второго атрибута и т.д. Если количество атрибутов сортировки – n, то n+1 вложенная пара ```#xsl:for-each ... #xsl:end``` ограничивает тело цикла по бизнес объектам сгруппированным по значениям атрибутов группировки.

Внутри пары ```#xsl:group-by ... #xsl:end``` доступны команды:

* 	```#group-by-groups(индекс_атрибута_группировки_в_списке_группировки)``` – отображает значение атрибута для текущей группы. (внутри цикла по значениям первого атрибута можно вывести значение первого атрибута #group-by-groups(0), внутри второго цикла – значение первого и второго атрибутов и т.д.) 
* 	```#group-by-sum(путь_к_атрибуту_суммирования)``` – подсчитывает сумму атрибута для текущей группы (промежуточная сумма) 
* 	```#group-by-count ```– количество групп или объектов в текущей группе 
* 	```#group-by-countAll``` – количество объектов в текущей группе и всех вложенных в нее группах 


```%%#xsl:group-by select='{*}' paths='{attr1};{attr2}'%%

    %%#xsl:for-each select='{*}'%%

            %%{#OrderNum#}%%; %%{#group-by-groups(0)}%%

            %%#xsl:for-each select='{*}'%%

                    %%{#OrderNum#}%%; %%{#group-by-groups(0)}%%; %%{#group-by-groups(1)}%%

                    %%#xsl:for-each select='{*}'%%

                            <<тело отчета>> вывод атрибутов бизнес-объекта

                    %%#xsl:end%%

                    %%{#group-by-count}%%; %%{#group-by-sum(путь)}%%

            %%#xsl:end%%

            %%{#group-by-count}%%; %%{#group-by-countAll}%%; %%{#group-by-sum(путь)}%%

    %%#xsl:end%%

    вывод суммарных данных по всем объектам

    %%{#group-by-count}%%; %%{#group-by-countAll}%%; %%{#group-by-sum(путь)}%%

%%#xsl:end%%```


Для MS Word XML Document шаблонов элемент groupby.

## Заголовок цикла (#xsl:once) и нижний заголовок цикла (#xsl:footer)

Инструкции ```#xsl:once``` и ```#xsl:footer``` определяют часть тела цикла, которая должна быть выведена в отчет единожды. Содержимое ```#xsl:once``` выводится на первой итерации цикла, ```#xsl:footer``` – после последней итерации. Используются только внутри циклической инструкции, внутри пары ```#xsl:for-each ... #xsl:end```. Начало и конец неповторяемого блока определяются инструкциями ```#xsl:once ... #xsl:end``` и ```#xsl:footer ... #xsl:end```.

```%%#xsl:for-each select='{*}'%%

    %%#xsl:once%%

            <<заголовок>>

    %%#xsl:end%%

    <<тело цикла>>

%%#xsl:end%%
%%#xsl:for-each select='{*}'%%

    <<тело цикла>>

    %%#xsl:footer%%

            <<результат цикла>>

    %%#xsl:end%%

%%#xsl:end%%```
