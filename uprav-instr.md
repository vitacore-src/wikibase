<!-- TITLE: Управляющие инструкции -->
<!-- SUBTITLE: Руководство пользователя системы «ВИТАКОР»-->

Выходной документ формируется по шаблону. Шаблон – это документ того же формата, что и выходной документ, в котором содержатся инструкции генератора отчетов GEst. Набором представленных в шаблоне инструкций определяется какие атрибуты и коллекции объектовпопадут в отчет. Инструкции в теле шаблона обрамляются строкой "%%", кроме шаблонов в формате MS Word XML Document.

```%%{User/Name}%%```

Для шаблонов MS Word XML Document используется набор кастомных xml тэгов, которые размещаются в теле шаблона.

Поддерживается два типа инструкций:
* 	управляющие инструкции, 
* 	инструкции вывода значений. 
 	
Первые используются для организации циклов, для группировок объектов по значениям атрибутов и т.п., вторые - для непосредственного вывода значений в выходной документ (атрибуты объектов, вычислимые атрибуты генератора отчетов).

Вставка инструкций в шаблоны производится либо вручную, либо средствами библиотеки. Поддерживается автоматическая генерация шаблона из GUI генератора отчетов (см. "Генератор отчетов руководство пользователя") и вставка инструкций в приложениях MS Office (см. "MS Office add-in генерации шаблонов отчетных документов").

Управляющие инструкции
Управляющие инструкции разбивают шаблон на области. В зависимости от типа инструкции, ограниченная ею область либо выводится в отчет несколько раз (#xsl:for-each), либо выводится в отчет по условуию (#xsl:if) и т.п.. Генератор разбирает файл шаблона, отыскивает в нем управляющие инструкции и выводит данные объектов в соответствии с ними.

# Управляющие инструкции

Управляющие инструкции разбивают шаблон на области. В зависимости от типа инструкции, ограниченная ею область либо выводится в отчет несколько раз (#xsl:for-each), либо выводится в отчет по условуию (#xsl:if) и т.п.. Генератор разбирает файл шаблона, отыскивает в нем управляющие инструкции и выводит данные объектов в соответствии с ними.

## Инструкция циклического блока (#xsl:for-each)

```%%#xsl:for-each select='Path1' sort='Path2;Path3' filter='Lexem' minCount='5' maxCount='10'%%```

Атрибут1: ```%%Path4%%```

Атрибут2: ```%%Path5%%```

```%%#xsl:end%%```

Инструкция предназначена для организации цикла по коллекции объектов. Инструкция задается командами: ```#xsl:for-each``` – начало тела цикла и ```#xsl:end``` – конец тела цикла. Фрагмент документа, заключенный между ними повторяется в выходном документе столько раз, сколько объектов, удовлетворяющих параметрам управляющей инструкции, содержится в коллекции. Инструкция ```#xsl:for-each``` имеет один обязательный параметр – ```select```.

Параметры поддерживаемые управляющей инструкцией:
```select='путь_к_коллекции'```. Обязательный параметр. Указывает по какой коллекции текущего объекта будет производится цикл. Допускается в качестве пути к коллекции указание – {*}, что означает цикл по элементам текущей коллекции. 

```sort='перечень_путей'```. Указывает сортировку, заданную внутри цикла для выводимой в цикле коллекции. Может содержать один, или более путей к атрибутам. Пути к атрибутам разделяются точкой с запятой(«;») Например, ```sort='{путь_к_атрибуту1};{путь_к_атрибуту2}'```. В итоге коллекция объектов, выводимая в цикле будет отсортирована сначала по первому атрибуту, затем по второму. 

```filter='представление_лексемы'```. Указывает применяемый в памяти фильтр к объектам коллекции. Если текущий элемент не удовлетворяет заданному фильтру, то тело цикла для этого объекта не выводится. 

```minCount='целое_число'```. Задает наименьшее количество итераций которое должно быть выполнено инструкцией циклического блока. Значение должно быть меньше maxCount. Параметр используется, например, когда выходной документ должен содержать повторяющийся блок вне зависимости от того есть ли объекты в коллекции. В этом случае блок повторяется в документе указанное количество раз с пустыми значениями содержащихся в нем управляющих инструкций. 

```maxCount='целое_число'```. Задает максимально возможное число итераций выполняемых инструкцией циклического блока. Значение должно быть больше minCount. 

Для MS Word XML Document шаблонов элемент foreach.

## Группировка коллекции (#xsl:group-by)

Инструкция группирует объекты по значениям заданного набора атрибутов. Группировка объектов задается командами: ```#xsl:group-by``` – начало тела группировки и ```#xsl:end``` – конец группировки. Так же как и для ```for-each``` можно задается

* 	```select='путь_к_группируемой_коллекции'``` – обязательный параметр; 
* 	```sort='перечень_путей'```; 
* 	```filter='представление_лексемы'```. 
* 	```paths='перечень_путей'``` - обязательный параметр, перечень путей к атрибутам, по которым производится группировка объектов. 

В group-by необходимо вложить несколько пар ```#xsl:for-each ... #xsl:end```. Их количество на единицу больше числа атрибутов группировки. Первая вложенная пара образует цикл по группам, образованным значениями первого атрибута группировки, вторая – второго атрибута и т.д. Если количество атрибутов сортировки – n, то n+1 вложенная пара ```#xsl:for-each ... #xsl:end``` ограничивает тело цикла по бизнес объектам сгруппированным по значениям атрибутов группировки.

Внутри пары ```#xsl:group-by ... #xsl:end``` доступны команды:

* 	```#group-by-groups(индекс_атрибута_группировки_в_списке_группировки)``` – отображает значение атрибута для текущей группы. (внутри цикла по значениям первого атрибута можно вывести значение первого атрибута #group-by-groups(0), внутри второго цикла – значение первого и второго атрибутов и т.д.) 
* 	```#group-by-sum(путь_к_атрибуту_суммирования)``` – подсчитывает сумму атрибута для текущей группы (промежуточная сумма) 
* 	```#group-by-count ```– количество групп или объектов в текущей группе 
* 	```#group-by-countAll``` – количество объектов в текущей группе и всех вложенных в нее группах 
 
 ```
%%#xsl:group-by select='{*}' paths='{attr1};{attr2}'%%

    %%#xsl:for-each select='{*}'%%

            %%{#OrderNum#}%%; %%{#group-by-groups(0)}%%

            %%#xsl:for-each select='{*}'%%

                    %%{#OrderNum#}%%; %%{#group-by-groups(0)}%%; %%{#group-by-groups(1)}%%

                    %%#xsl:for-each select='{*}'%%

                            <<тело отчета>> вывод атрибутов бизнес-объекта

                    %%#xsl:end%%

                    %%{#group-by-count}%%; %%{#group-by-sum(путь)}%%

            %%#xsl:end%%

            %%{#group-by-count}%%; %%{#group-by-countAll}%%; %%{#group-by-sum(путь)}%%

    %%#xsl:end%%

    вывод суммарных данных по всем объектам

    %%{#group-by-count}%%; %%{#group-by-countAll}%%; %%{#group-by-sum(путь)}%%

%%#xsl:end%%
 
```

Для MS Word XML Document шаблонов элемент groupby.

## Заголовок цикла (#xsl:once) и нижний заголовок цикла (#xsl:footer)

Инструкции ```#xsl:once``` и ```#xsl:footer``` определяют часть тела цикла, которая должна быть выведена в отчет единожды. Содержимое ```#xsl:once``` выводится на первой итерации цикла, ```#xsl:footer``` – после последней итерации. Используются только внутри циклической инструкции, внутри пары ```#xsl:for-each ... #xsl:end```. Начало и конец неповторяемого блока определяются инструкциями ```#xsl:once ... #xsl:end``` и ```#xsl:footer ... #xsl:end```.

```
%%#xsl:for-each select='{*}'%%

    %%#xsl:once%%

            <<заголовок>>

    %%#xsl:end%%

    <<тело цикла>>

%%#xsl:end%%
%%#xsl:for-each select='{*}'%%

    <<тело цикла>>

    %%#xsl:footer%%

            <<результат цикла>>

    %%#xsl:end%%

%%#xsl:end%%
```

В качестве объекта для инструкций устанавливается коллекция родительской циклической инструкции. Инструкции используются для вывода верхнего/нижнего заголовков таблицы генерируемой циклической управляющей инструкцией и вывода аггрегирующих вычислимых значений #Sum, #Count.

Для MS Word XML Document шаблонов элементы once и footer соответственно.

## Условная управляющая инструкция (#xsl:if)

Инструкция задает часть шаблона, которая выводится в документ при выполнении заданного условия.

```%%#xsl:if lexem='строковое или xml представление лексемы'%%```

Контент, выводимый в отчет по условию

```%%#xsl:end%% ```

Условием является лексема. В шаблоне лексема представляется либо обычной, либо xml-строкой, что определяется по первому символу (xml-строка начинается с символа "<"). В первом случае для парсинга лексемы из строки используется GEst.Expression.LexemProcessor, во втором GEst.Common.XmlHRSerializer класс. Если условие выполняется (метод Evaluate лексемы возвращает true), то содержимое выводится в отчет.

```
%%#xsl:if lexem='<lx:Criterion not="1" ... </lx:Criterion>'%%

    Количество: %%{Count}%%

%%#xsl:end%%
```
Для MS Word XML Document шаблонов элемент if.

# Вывод значений в отчеты
Для вывода значения в выходной документ используется строковое представление лексемы обрамленное строкой "%%".
```
%%{Customer/Name}%%
```
По строковому представлению в шаблоне определяется тип и параметры лексемы. Наиболее часто используемые в отчетах типы лексем это:
* 	путь (Path), 
* 	запрашиваемое у пользователя значение (UserQueryOperand), 
* 	значение из холдера глобальных параметров (ParamHolderParam), 
* 	гиперссылка (HLink). 

## Часто используемые лексемы
### Путь Path

Path используется для вывода значений атрибутов объектов, поддерживающих интерфейс IRequestAttribute. Например, бизнес объекты в библиотеке (BaseObject) имплементируют этот интерфейс.
```
%%{Customer/Name}%%
```
Для MS Word XML Document шаблонов атрибут path элемента data.

### Запрашиваемое значение UserQueryOperand

UserQueryOperand лексема представляющая запрос пользователю перед формированием отчета. UserQueryOperand используются в фильтрах, накладываемых на данные отчета, в лексемах внутри управляющих инструкций, и в качестве простых полей в теле шаблона. Один UserQueryOperand может встречаться в шаблоне более одного раза и участвовать в фильтре отчета. Совпадение определяется по имени и типу.

```
%%uqo("Дата начала",Const,"System.DateTime","dd.MM.yyyy")%%

%%uqo("Исполнитель",Entity,"NATURAL_PERSON")%%

%%uqo("Тип загрузки данных",Enum,"ReportLoadDataType")%%

%%uqo("Перечисление",Choice,"EntityName","AttributeName")%%
```
Для MS Word XML Document шаблонов атрибут uqo элемента data.

### Значение из холдера глобальных параметров ParamHolderParam

ParamHolderParam выводит в отчет текущее значение из холдера глобальных параметров.
```
%%param(CURRENT_USER_NAME)%%

%%param(CURRENT_DATE, "dd.MM.yyyy")%%
```
Для MS Word XML Document шаблонов атрибут param элемента data.

### Гиперссылка HLink

Hlink размещает в шаблоне гиперссылку с задаными параметрами. При активации гиперссылки в окне клиентского приложения откроется форма объекта, на который гиперссылка ссылается. Только для отчетов MS Word, MS Excel и Html форматов. Подробнее о применении гиперссылок в отчетах описано в разделе Гиперссылки (hlink).
```
%%hlink({RepName}, {.}, {RepDesc})%%

%%hlink({RepFmtID/Name})%%

%%hlink({RepName})%%
```

Для MS Word XML Document шаблонов атрибут hlink элемента data.

## Вычисляемые значения генератора отчетов


Генератор отчетов поддерживает набор вычисляемых значений: порядковый номер в коллекции, сумма атрибута по коллекции и т.п. Эти значения не являются атрибутами объектов, а вычисляются генератором в при формировании отчета. В шаблонах они представляются лексемой Path, содержащей единственный строковый элемент (StepString), имя которого начинается с символа "#". Поддерживается форматирование так же как для Path. В качестве объекта в метод Evaluate для таких лексем подается созданный (вычисленный) генератором отчетов объект.
```
%%{#OrderNum#}%%
```


### Порядковый номер в цикле (#OrderNum#)

Инструкция выводит порядковый номер итерации в цикле, начиная с 1. Использование имеет смысл только внутри пар ```#xsl:for-each ... #xsl:end и #xsl:group-by ... #xsl:end.```
```
%%{#OrderNum#(номер_старшего_цикла, признак_сквозной_нумерации)%%
```

При использовании без параметров, выводит порядковый номер итерации в цикле, в который инструкция вложена.
```
%%#xsl:for-each select='{*}'%%

%%{#OrderNum#}%%.

%%#xsl:end%%


Результат:

1.

2.

...
```
С параметрами используется, когда в шаблоне имеются вложенные циклы.

Первый параметр – числовой, используется для указания глубины вложенности инструкции в старший цикл. Выводит порядковый номер итерации в старшем цикле. Нулевым считается цикл, в который вложена инструкция. То есть использование ```%%#OrderNum#%%``` идентично использованию – ```%%#OrderNum#(0)%%.```

Второй параметр – любого типа (учитывается только его наличие), используется для вывода сквозной нумерации объектов. Признак объекта – (not IList), поэтому инструкцию с двумя параметрами удобно использовать в группировках, где элементами в циклах являются группы объектов (IList), и только в младшем цикле элементом является объект (not IList). Второй параметр в этом случае включает вывод сквозной нумерации объектов несмотря на группы в которую каждый из них попал. Перый параметр в этом случае определяет цикл (по группам образованным значениями заданного атрибута), сквозная нумерация объектов для которого выводится, то есть все объекты выводимые этим циклом будут иметь сквозную нумерацию.
```
%%#xsl:group-by select='{*}' paths='{attr1};{attr2}'%%

    %%#xsl:for-each select='{*}'%%

            %%#xsl:for-each select='{*}'%%

                    %%#xsl:for-each select='{*}'%%

%%{#OrderNum#(2,0)}%%(%%{#OrderNum#(1,0)}%%).
%%{#OrderNum#(2)}%%.%%{#OrderNum#(1)}%%.%%{#OrderNum#}%%

                    %%#xsl:end%%

            %%#xsl:end%%

    %%#xsl:end%%

%%#xsl:end%%


Результат:

1(1). 1.1.1

2(2). 1.1.2

3(3). 1.2.1

4(4). 1.2.2

5(1). 2.1.1

6(2). 2.1.2

7(3). 2.2.1

8(4). 2.2.2
```

### Сумма атрибута объектов в коллекции (#Sum)

Инструкция суммирует зн ачение атрибута для коллекции обектов.
```
%%{#Sum(путь_к_атрибуту, путь_к_коллекции, "xml представление
фильтра")}%%
```
Первый параметр – обязательный, определяет суммируемый атрибут, который должен быть числовым.

Второй параметр – не обязательный, задает путь к коллекции объектов значение атрибута которых суммируется. В случае, когда второй параметр отсутсвует или представлен как {*}, в качестве коллекции используется коллекция объектов родительской управляющей инструкции, той внутрь которой помещена сумма.

Для фильтрации объектов в коллекции используется третий параметр – не обязательный.

Двойные кавычки в xml представлении фильтра заменяются последовательностью символов "&quot;".
```
%%{#Sum({Price})}%%

%%{#Sum({DocumentID/DocType/Code},{DOC_EDITORS}, "<lx:Criterion not=&quot;1&quot; ... </lx:Criterion>")}%%
%%#xsl:for-each select='{*}'%%

...

%%#xsl:footer%%

%%{#Sum({Quantity})}%%

%%#xsl:end%%

%%#xsl:end%%
```

Путь к коллекции может идти через несколько подчиненных дочерних коллекций. Использование такой инструкции рассмотрим на примере.
```
%%#xsl:for-each select='{*}'%%


отчет "%%{RepName}%%" - %%{#Sum({FileSize},{FileGroups/Files})}%% байт в
%%{#Count({FileGroups/Files})}%% файлах


    %%#xsl:for-each select='{FileGroups}'%%


группа "%%{Name}%%" - %%{#Sum({FileSize},{Files})}%% байт в %%{#Count({Files})}%% файлах


            %%#xsl:for-each select='{Files}'%%


файл "%%{FileName}%%" - %%{FileSize}%%


            %%#xsl:end%%

    %%#xsl:end%%

%%#xsl:end%%


Итого по всем отчетам: %%{#Sum({FileSize},{*/FileGroups/Files})}%% байт в
%%{#Count({*/FileGroups/Files})}%% файлах
```

Здесь отображаются объекты отчеты, их дочерняя коллекция группы файлов "FileGroups", и файлы которые в свою очередь являются элементами дочерней коллекции "Files", принадлежащей группам файлов "FileGroups". То есть у отчета может быть несколько групп файлов, а у группы файлов – несколько файлов. В примере подсчитывается сумма размеров файлов

* 	для всех отчетов в целом #Sum({FileSize},{*/FileGroups/Files}), 
* 	для каждого отчета в отдельности #Sum({FileSize},{FileGroups/Files}), 
* 	для каждой группы в отдельности #Sum({FileSize},{Files}). 

Меняется только путь к колекции в зависимости от места расположения инструкции в шаблоне.

### Количество объектов в коллекции (#Count)

Инструкция выводит количество элементов в коллекции.
```
%%{#Count(путь_к_коллекции,"xml представление фильтра")}%%
```
Первый параметр – путь к коллекции, в случае когда отсутсвует или представлен как {*}, в качестве коллекции используется коллекция объектов родительской управляющей инструкции, той внутрь которой помещена инструкция.

Для фильтрации объектов в коллекции используется второй параметр – не обязательный. Двойные кавычки в xml представлении фильтра заменяются последовательностью символов "&quot;".
```
%%{#Count({LINK_RECORD_CARDS_DOCUMENTS}, "<lx:Criterion not=&quot;1&quot;...</lx:Criterion>")}%%
%%#xsl:for-each select='{*}'%%

...

    %%#xsl:footer%%

            %%{#Count}%%

    %%#xsl:end%%

%%#xsl:end%%
```

Путь к коллекции может идти через несколько подчиненных дочерних коллекций. Использование такой инструкции рассмотрим на примере.
```
%%#xsl:for-each select='{*}'%%

отчет "%%{RepName}%%" - %%{#Sum({FileSize},{FileGroups/Files})}%% байт в %%{#Count({FileGroups/Files})}%% файлах

    %%#xsl:for-each select='{FileGroups}'%%

группа "%%{Name}%%" - %%{#Sum({FileSize},{Files})}%% байт в %%{#Count({Files})}%% файлах

            %%#xsl:for-each select='{Files}'%%

файл "%%{FileName}%%" - %%{FileSize}%%

            %%#xsl:end%%

    %%#xsl:end%%

%%#xsl:end%%

Итого по всем отчетам: %%{#Sum({FileSize},{*/FileGroups/Files})}%% байт в %%{#Count({*/FileGroups/Files})}%% файлах
```

Здесь отображаются объекты отчеты, их дочерняя коллекция группы файлов "FileGroups", и файлы которые в свою очередь являются элементами дочерней коллекции "Files", принадлежащей группам файлов "FileGroups". То есть у отчета может быть несколько групп файлов, а у группы файлов – несколько файлов. В примере выводится количество файлов

* 	для всех отчетов в целом #Count({*/FileGroups/Files}), 
* 	для каждого отчета в отдельности #Count({FileGroups/Files}), 
* 	для каждой группы в отдельности #Count({Files}). 
 	
Меняется только путь к колекции в зависимости от места расположения инструкции в шаблоне. Фильтр в этом случае накладывается на сущность до которой ведет путь.

**Вычисляемые атрибуты внутри группирующей инструкции (#group-by-groups, #group-by-sum, #group-by-count, #group-by-countAll)**

Вычисляемые значения #group-by-groups, #group-by-sum, #group-by-count, #group-by-countAll используются только внутри группирующей инструкции, в разделе которой описано их использование.


# Лексемы генератора отчетов